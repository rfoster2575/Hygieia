package com.capitalone.dashboard.collector;

import com.capitalone.dashboard.model.vulnerability.ArtifactType;
import com.capitalone.dashboard.model.vulnerability.JenkinsJob;
import com.capitalone.dashboard.model.vulnerability.JenkinsPredicate;
import com.capitalone.dashboard.model.vulnerability.JenkinsSettings;
import com.capitalone.dashboard.model.vulnerability.JenkinsVulnerabilityCollector;
import com.capitalone.dashboard.model.vulnerability.JenkinsVulnerabilityJob;
import com.capitalone.dashboard.repository.JenkinsVulnerabilityCollectorRepository;
import com.capitalone.dashboard.repository.JenkinsVulnerabilityJobRepository;
import com.capitalone.dashboard.utils.VulnerabilityService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.TaskScheduler;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Component
public class JenkinsVulnerabilityCollectorTask extends CollectorTask<JenkinsVulnerabilityCollector> {

    private static final String DESCRIPTION_FORMAT = "%s (%s)";

    private JenkinsVulnerabilityCollectorRepository collectorRepository;
    private JenkinsVulnerabilityJobRepository jobRepository;
    private JenkinsSettings settings;
    private JenkinsClient jenkinsClient;
    private VulnerabilityService vulnerabilityService;

    @Autowired
    public JenkinsVulnerabilityCollectorTask(TaskScheduler taskScheduler, JenkinsVulnerabilityCollectorRepository repository,
                                           JenkinsVulnerabilityJobRepository jobRepository, JenkinsSettings settings,
                                           JenkinsClient jenkinsClient, VulnerabilityService vulnerabilityService) {
        super(taskScheduler, "JenkinsVulnerability");
        this.collectorRepository = repository;
        this.jobRepository = jobRepository;
        this.settings = settings;
        this.jenkinsClient = jenkinsClient;
        this.vulnerabilityService = vulnerabilityService;
    }

    public JenkinsVulnerabilityCollector getCollector() {
        return JenkinsVulnerabilityCollector.prototype(this.settings.getServers());
    }

    @Override
    public JenkinsVulnerabilityCollectorRepository getCollectorRepository() {
        return this.collectorRepository;
    }

    @Override
    public String getCron() {
        return this.settings.getCron();
    }

    @Override
    public void collect(JenkinsVulnerabilityCollector collector) {
        long start = System.currentTimeMillis();
        
        final List<String> buildServers = collector.getBuildServers();
        final List<JenkinsJob> jobs = this.jenkinsClient.getJobs(buildServers);
        if (null == jobs) {
            return;
        }

        List<JenkinsJob> allJobsOnServer = jobs.stream().flatMap(JenkinsJob::streamJobs).collect(Collectors.toList());
        this.cleanupPreviousJobsFromRepo(collector, allJobsOnServer);


        List<Pattern> matchingJobPatterns = new ArrayList<>();
        Map<ArtifactType, Pattern> artifactTypePatternMap = new HashMap<>();
        this.settings.getArtifactRegex().forEach(
                (key, uncompiledPatternList) -> uncompiledPatternList.stream().forEach(
                        unCompiledPattern -> {
                            Pattern compiledPattern = Pattern.compile(unCompiledPattern);
                            matchingJobPatterns.add(compiledPattern);
                            artifactTypePatternMap.put(key, compiledPattern);
                        }
                )
        );

        List<JenkinsJob> interestingJobs = jobs.stream().flatMap(JenkinsJob::streamJobs).filter(JenkinsPredicate.artifactInJobContaining(matchingJobPatterns)).collect(Collectors.toList());

        this.createAnyNewJobs(collector, interestingJobs);

        List<JenkinsVulnerabilityJob> allJobs = this.jobRepository.findAllByCollectorId(collector.getId());
        if (null != allJobs) {
            final Map<String, JenkinsVulnerabilityJob> jenkinsVulnerabilityJobMap = allJobs.stream().collect(Collectors.toMap(JenkinsVulnerabilityJob::getJenkinsServer, Function.identity()));

            for (JenkinsJob job : interestingJobs) {
                Map<ArtifactType, String> allTypes = new HashMap<>();
                artifactTypePatternMap.forEach((type, pattern) -> {
                    if (type == ArtifactType.owasp || type == ArtifactType.retirejs) {
                        allTypes.putAll(this.jenkinsClient.getLatestArtifacts(job, type, pattern));
                    } else {
                        this.log("not collecting data for "+type+ " yet");
                    }
                });
                this.vulnerabilityService.storeLibraryPolicy(job, jenkinsVulnerabilityJobMap.get(job.getUrl()), allTypes);
            }
        }

        log("examined jobs",start,null==allJobs?0:allJobs.size());
    }

    private void cleanupPreviousJobsFromRepo(JenkinsVulnerabilityCollector collector, List<JenkinsJob> jobs) {
        List<String> configuredServers = jobs.stream().map(job -> job.getUrl()).collect(Collectors.toList());
        List<JenkinsVulnerabilityJob> allRepoJobs = new ArrayList(this.jobRepository.findAllByCollectorId(collector.getId()));
        List<JenkinsVulnerabilityJob> jobsToKeep = allRepoJobs.stream().filter(
            job ->
                configuredServers.contains(job.getJenkinsServer())
        ).collect(Collectors.toList());
        allRepoJobs.removeAll(jobsToKeep);
        allRepoJobs.forEach(job -> {
            this.jobRepository.delete(job);
        });
    }

    private void createAnyNewJobs(JenkinsVulnerabilityCollector collector, List<JenkinsJob> buildServerJobs) {
        List<JenkinsVulnerabilityJob> allRepoJobs = new ArrayList<>(this.jobRepository.findAllByCollectorId(collector.getId()));

        List<JenkinsJob> newJobs = new ArrayList<>(buildServerJobs).stream().filter(jenkinsJob ->
                !allRepoJobs.stream().anyMatch(
                        repoJob ->
                                repoJob.getJenkinsServer().equals(jenkinsJob.getUrl())
                )
        ).collect(Collectors.toList());

        newJobs.forEach(job -> {
            JenkinsVulnerabilityJob newJob = JenkinsVulnerabilityJob.newBuilder().
                    collectorId(collector.getId()).jobName(job.getName()).jenkinsServer(job.getUrl()).
                    description(String.format(DESCRIPTION_FORMAT, job.getName(), job.getUrl())).build();
            this.jobRepository.save(newJob);
        });
    }
}
